version: '3.8'

services:
  neo4j:
    image: neo4j:${NEO4J_VERSION}
    container_name: neo4j-cyber

    ports:
      - "${NEO4J_HTTP_PORT}:7474"   # Neo4j Browser
      - "${NEO4J_BOLT_PORT}:7687"   # Bolt (driver / cypher-shell)

    volumes:
      # 데이터 영속성
      - ./neo4j_data:/data
      - ./neo4j_logs:/logs

      # CSV import 용
      - ./data/processed:/var/lib/neo4j/import

      # 플러그인 (APOC만 사용)
      - ./plugins:/plugins

    environment:
      # ===== 기본 인증 =====
      - NEO4J_AUTH=${NEO4J_USER}/${NEO4J_PASSWORD}

      # ===== 네트워크 (Neo4j 5.x 필수) =====
      - NEO4J_server_http_listen__address=0.0.0.0:7474
      - NEO4J_server_bolt_listen__address=0.0.0.0:7687
      - NEO4J_server_bolt_advertised__address=localhost:7687

      # ===== 플러그인 =====
      # ⚠️ GDS 제거 (Neo4j 5.19 Community와 호환 안 됨)
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_ACCEPT_LICENSE_AGREEMENT=yes

      # ===== APOC 권한 =====
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*

      # ===== 메모리 =====
      - NEO4J_server_memory_heap_initial__size=512m
      - NEO4J_server_memory_heap_max__size=2G

    restart: unless-stopped
